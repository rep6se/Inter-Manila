<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matches — Inter Manila</title>
<style>
body{
  margin:0;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#0f172a;
  color:#f1f5f9;
}
.header{
  background:#020617;
  padding:18px;
  font-size:24px;
  font-weight:bold;
  text-align:center;
  border-bottom:2px solid #334155;
}
.container{
  padding:20px;
  max-width:700px;
  margin:auto;
}
input, select{
  width:100%;
  padding:10px;
  margin:6px 0 12px 0;
  border-radius:8px;
  border:none;
  background:#1e293b;
  color:white;
  font-size:14px;
}
button{
  width:100%;
  padding:14px;
  font-weight:bold;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  cursor:pointer;
  margin-top:10px;
  transition:0.2s;
}
button:hover{
  background:#1d4ed8;
}
.match-card{
  background:#1e293b;
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
}
.back{
  margin-top:20px;
  display:block;
  text-align:center;
  color:#93c5fd;
  text-decoration:none;
}
.player-stats{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.player-stats input{
  flex:1;
  min-width:60px;
}
</style>
</head>
<body>

<div class="header">Matches — Inter Manila</div>

<div class="container">

<label for="league">League</label>
<select id="leagueSelect"></select>

<label for="scoreFor">Inter Manila Score</label>
<input type="number" id="scoreFor" min="0" value="0">

<label for="scoreAgainst">Opponent Score</label>
<input type="number" id="scoreAgainst" min="0" value="0">

<h3>Player Stats</h3>
<div id="playerStatsContainer">Loading players...</div>

<button onclick="addMatch()">Add Match</button>

<a class="back" href="dashboard.html">← Back to Dashboard</a>

<div id="message"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuqUcXYjMU-XaL_w7h4y43RHku4dQGFlk",
  authDomain: "inter-manila.firebaseapp.com",
  projectId: "inter-manila",
  storageBucket: "inter-manila.firebasestorage.app",
  messagingSenderId: "285507279342",
  appId: "1:285507279342:web:5aa0c80a08fb92727416ff"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* Protect page */
onAuthStateChanged(auth,(user)=>{
  if(!user) window.location.href="index.html";
});

/* Load leagues */
async function loadLeagues(){
  const leagueSnap = await getDocs(collection(db,"leagues"));
  let html="";
  leagueSnap.forEach(docSnap=>{
    html += `<option value="${docSnap.data().name}">${docSnap.data().name}</option>`;
  });
  document.getElementById("leagueSelect").innerHTML = html;
}
loadLeagues();

/* Load players */
let playersList = [];
async function loadPlayers(){
  const snapshot = await getDocs(collection(db,"players"));
  playersList = [];
  let html="";
  snapshot.forEach(docSnap=>{
    const p = docSnap.data();
    playersList.push({id: docSnap.id, name:p.name});
    html+=`
      <div class="player-stats">
        <div style="flex:2">${p.name}</div>
        <input type="number" placeholder="Goals" id="g_${docSnap.id}" min="0" value="0">
        <input type="number" placeholder="Assist" id="a_${docSnap.id}" min="0" value="0">
        <input type="number" placeholder="Saves" id="s_${docSnap.id}" min="0" value="0">
      </div>
    `;
  });
  document.getElementById("playerStatsContainer").innerHTML = html;
}
loadPlayers();

/* Add Match */
window.addMatch = async function(){
  const league = document.getElementById("leagueSelect").value;
  const scoreFor = parseInt(document.getElementById("scoreFor").value)||0;
  const scoreAgainst = parseInt(document.getElementById("scoreAgainst").value)||0;

  const playerStats=[];
  for(const p of playersList){
    const goals = parseInt(document.getElementById(`g_${p.id}`).value)||0;
    const assist = parseInt(document.getElementById(`a_${p.id}`).value)||0;
    const saves = parseInt(document.getElementById(`s_${p.id}`).value)||0;

    playerStats.push({id:p.id, goals, assist, saves});

    // update player stats total
    const playerRef = doc(db,"players",p.id);
    const playerSnap = await getDocs(collection(db,"players"));
    const playerDoc = await playerRef.get();
    const data = playerDoc.data();
    await updateDoc(playerRef,{
      goals: Number(data.goals||0)+goals,
      assist: Number(data.assist||0)+assist,
      saves: Number(data.saves||0)+saves,
      match: Number(data.match||0)+1,
      leagues: Array.isArray(data.leagues) 
                ? (data.leagues.includes(league) ? data.leagues : [...data.leagues,league])
                : [league]
    });
  }

  // Add match document
  await addDoc(collection(db,"matches"),{
    liga: league,
    score_for: scoreFor,
    score_against: scoreAgainst,
    date: new Date(),
    players: playerStats
  });

  document.getElementById("message").innerText="Match added successfully!";
  loadPlayers(); // reset inputs
}
</script>
</body>
</html>
